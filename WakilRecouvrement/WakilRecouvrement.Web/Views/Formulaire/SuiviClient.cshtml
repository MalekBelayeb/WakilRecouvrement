@model WakilRecouvrement.Domain.Entities.Formulaire

@{
    ViewBag.Title = "";
}

<h2>Suivi des clients affectés</h2>

<script src="//ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>
<link href="~/lib/bootstrap/dist/css/bootstrap.css" rel="stylesheet" />

<link href="https://cdn.datatables.net/1.10.15/css/dataTables.bootstrap.min.css" rel="stylesheet" />
<link href="https://cdn.datatables.net/responsive/2.1.1/css/responsive.bootstrap.min.css" rel="stylesheet" />


<script src="https://cdn.datatables.net/1.10.15/js/jquery.dataTables.min.js"></script>

<script src="https://cdn.datatables.net/1.10.15/js/dataTables.bootstrap4.min.js">
</script>



<br />

<div class="row">
    <div class="col-xs-3">

        @Html.DropDownList("numLot", ViewData["list"] as SelectList, new { @class = "form-control" })

    </div>
    <div class="col-xs-3 col-md-5">


        @Html.DropDownList("traite", ViewBag.TraiteList as SelectList, new { @class = "form-control" })

    </div>
    <div class="col-xs-3">

        @Html.DropDownList("agent", ViewBag.AgentList as SelectList, new { @class = "form-control" })

    </div>
</div>

<br />
<table class="table table-bordered">
<thead>
    <tr>
        <th scope="col">Total</th>
        <th scope="col">Soldé</th>
        <th scope="col">Tranche</th>
        <th scope="col">Faux Num</th>
    </tr>
</thead>
<tbody>
    <tr>
        <td><strong id="nbTotal"></strong> </td>
        <td><strong class="text-success" id="nbSolde"></strong> </td>
        <td > <strong id="nbTrancheSoldeTotal" class="text-success"></strong> </td>
        <td> <strong  id="nbFNTotal" class="text-danger"></strong> </td>
    </tr>
</tbody>
</table>
<table id="demodata" class="table table-striped table-bordered dt-responsive nowrap">
    <thead>
        <tr>
            <th>Etat Client</th>
            <th>Affecté Le</th>
            <th>Affecté Pour</th>

            <th>NumClient</th>
            <th>NumLot</th>
            <th>Compte</th>
            <th>IDClient</th>
            <th>NomClient</th>
            <th>TelPortable</th>
            <th>TelFixe</th>
            <th>Solde debiteur</th>
            <th>Agence</th>
            <th>Adresse</th>
            <th>Type</th>
            <th>Numero</th>
            <th>AffId</th>
        </tr>
    </thead>
    <tbody></tbody>
</table>

<tr data-child-name="test1" data-child-value="10">
    <td>ParentRow</td>
    <td>No. 1</td>
</tr>

<script>



    $(document).ready(function () {
        $.noConflict();

        var Table = DemoDatatable();

        function format(d) {
            return '<table cellpadding="5" cellspacing="0" border="0" style="padding-left:50px;"><thead><tr><th>Etat Client</th><th>RDV Date </th><th>RDV Reporte Date </th><th>Tranche solde </th><th>Description autre </th></tr></thead><tbody>  ' +

                d

                + '</tbody></table>';
        }


        $('#demodata tbody').on('click', 'td', function () {
            var tr = $(this).closest('tr');
            var row = Table.row(tr);

            if (row.child.isShown()) {
                // This row is already open - close it
                row.child.hide();
                tr.removeClass('shown');
            }
            else {
                // Open this row

                $.ajax({
                    type: 'POST',
                    url: '/Formulaire/GetFormulaires/',
                    dataType: 'json',
                    data: { id: row.data()["AffectationId"] },
                    success: function (data) {
                        var x = '';
                        for (var i = 0; i < data["list"].length; i++) {

                            var desc = data["list"][i]["desc"]
                            var d1 = data["list"][i]["d1"]
                            var d2 = data["list"][i]["d2"]
                            if (d1 == "01/01/0001 00:00:00") {
                                d1 = ""
                            }
                            if (d2 == "01/01/0001 00:00:00") {
                                d2 = ""
                            }
                            if (desc == null) {
                                desc = ""
                            }

                            x += '<tr>' +

                                '<td>' + data["list"][i]["etat"] + '</td>' +
                                '<td>' + d1 + '</td>' +
                                '<td>' + d2 + '</td>' +
                                '<td>' + data["list"][i]["tranche"] + '</td>' +
                                '<td>' + desc + '</td>' +

                                '</tr>';

                        }

                        // console.log(x)
                        row.child(format(x)).show();

                        tr.addClass('shown');

                    }
                });



            }
        });




        $("#numLot").change(function () {

            Table = DemoDatatable();

        })

        $("#traite").change(function () {

            Table = DemoDatatable();

        })

        $("#agent").change(function () {

            Table = DemoDatatable();

        })

    });


    function DemoDatatable() {
        var table = $("#demodata").DataTable({
            "processing": true,
            "serverSide": true,
            "filter": true,
            "orderMulti": false,
            "destroy": true,
            "ordering": true,
            "ajax": {
                "url": '/Formulaire/LoadData',
                "type": "POST",
                "datatype": "json",
                "data": { numLot: $("#numLot").val(), traite: $("#traite").val(), agent: $("#agent").val() }
                
            },
            "columns": [
                { "data": "Etat", "name": "Etat", "autoWidth": true }
                , { "data": "DateAff", "name": "DateAff", "autoWidth": true }
                , { "data": "Username", "name": "Username", "autoWidth": true }
                , { "data": "LotId", "name": "LotId", "autoWidth": true }
                , { "data": "NumLot", "name": "NumLot", "autoWidth": true }
                , { "data": "Compte", "Name": "Compte", "autoWidth": true }
                , { "data": "IDClient", "name": "IDClient", "autoWidth": true }
                , { "data": "NomClient", "name": "NomClient", "autoWidth": true }
                , { "data": "TelPortable", "name": "TelPortable", "autoWidth": true }
                , { "data": "TelFixe", "name": "TelFixe", "autoWidth": true }
                , { "data": "SoldeDebiteur", "name": "SoldeDebiteur", "autoWidth": true }
                , { "data": "DescIndustry", "name": "DescIndustry", "autoWidth": true }
                , { "data": "Adresse", "name": "Adresse", "autoWidth": true }
                , { "data": "Type", "name": "Type", "autoWidth": true }
                , { "data": "Numero", "name": "Numero", "autoWidth": true }
                , { "data": "AffectationId", "name": "AffectationId", "autoWidth": true }


            ]
        });
        table.columns([13]).visible(false)

        table.on('xhr.dt',
            function (e, settings, data, xhr) {
                console.log(data["info"])
                document.getElementById("nbSolde").innerHTML = data["info"]["nbSoldeTotal"]
                document.getElementById("nbTotal").innerHTML = data["info"]["nbTotal"]
                document.getElementById("nbTrancheSoldeTotal").innerHTML = data["info"]["nbTrancheSoldeTotal"]
                document.getElementById("nbFNTotal").innerHTML = data["info"]["nbFNTotal"]
            });
        return table;
    }

</script>
@model IEnumerable<WakilRecouvrement.Domain.Entities.Formulaire>

@{
    ViewBag.Title = "";
}


<div class="card">
    <div class="card-header" id="headingTwo">

        <h2>Client à traiter </h2>

    </div>

    <div class="card-body">


                <table class="table table-bordered table-condensed table-responsive" style="display:table">
                    <tr>

                        <th>
                            NumLot
                        </th>

                        <th>
                            Compte
                        </th>
                        <th>
                            NomClient
                        </th>
                        <th>
                            TelPortable
                        </th>
                        <th>
                            TelFixe
                        </th>
                        <th>
                            SoldeDebiteur
                        </th>
                        <th>
                            Agence
                        </th>
                        <th>
                            Adresse
                        </th>
                        <th>
                            Type
                        </th>
                        <th>
                            Numero
                        </th>

                    </tr>


                    <tr class="p-3 mb-2 bg-white text-dark">
                        <td>
                            @ViewBag.affectation.Lot.NumLot
                        </td>

                        <td>
                            @ViewBag.affectation.Lot.Compte
                        </td>
                        <td>
                            @ViewBag.affectation.Lot.NomClient
                        </td>

                        @if (ViewBag.TelFN.TelPortableFN)
                        {
                            <td class="bg-secondary">
                                @ViewBag.affectation.Lot.TelPortable
                            </td>

                        }
                        else
                        {
                            <td>
                                @ViewBag.affectation.Lot.TelPortable
                            </td>
                        }

                        @if (ViewBag.TelFN.TelFixeFN)
                        {
                            <td class="bg-secondary">
                                @ViewBag.affectation.Lot.TelFixe
                            </td>
                        }
                        else
                        {
                            <td >
                                @ViewBag.affectation.Lot.TelFixe
                            </td>
                        }




                        <td>
                            @ViewBag.affectation.Lot.SoldeDebiteur
                        </td>
                        <td>
                            @ViewBag.affectation.Lot.DescIndustry
                        </td>
                        <td>
                            @ViewBag.affectation.Lot.Adresse
                        </td>
                        <td>
                            @ViewBag.affectation.Lot.Type
                        </td>
                        <td>
                            @ViewBag.affectation.Lot.Numero
                        </td>

                    </tr>


                </table>
            </div>
                </div>




        <br />


        <div class="card">
            <div class="card-header" id="headingTwo">

                <h2>Traiter Client</h2>

            </div>

            <div class="card-body">


                @using (Html.BeginForm("UpdateTelFN", "Formulaire", FormMethod.Post, new { onsubmit = "showFNLoading()" }))
                {
                    @Html.AntiForgeryToken()

                    <div class="row">

                        @if (ViewBag.affectation.Lot.TelPortable != "")
                        {

                            <div class="col-6">
                                <label for="telOne">Faux Num 1</label>

                                <div class="input-group">

                                    <div class="input-group-prepend">

                                        <span class="bg-gradient-danger input-group-text">

                                            @if (ViewBag.TelFN.TelPortableFN)
                                            {
                                                <input id="TelPortableid" checked name="TelPortable" type="checkbox">

                                            }
                                            else
                                            {
                                                <input id="TelPortableid" name="TelPortable" type="checkbox">

                                            }


                                        </span>
                                    </div>
                                    <input type="text" disabled value="@Html.Raw(ViewBag.affectation.Lot.TelPortable)" class="form-control">
                                </div>
                            </div>
                        }

                        @if (ViewBag.affectation.Lot.TelFixe != "")
                        {
                            <div class="col-6">
                                <label for="telOne">Faux num 2</label>

                                <div class="input-group">
                                    <div class="input-group-prepend">
                                        <span class="bg-gradient-danger input-group-text">

                                            @if (ViewBag.TelFN.TelFixeFN)
                                            {
                                                <input id="TelFixeid" checked name="TelFixe" type="checkbox">

                                            }
                                            else
                                            {
                                                <input id="TelFixeid" name="TelFixe" type="checkbox">

                                            }

                                        </span>
                                    </div>
                                    <input type="text" disabled value="@Html.Raw(ViewBag.affectation.Lot.TelFixe)" class="form-control">
                                </div>

                            </div>
                        }

                    </div>
                    <br />

                    <input hidden type="text" name="lotId"  value="@Html.Raw(ViewBag.affectation.Lot.LotId)" class="form-control">
                    <input hidden type="text" name="affectationId"  value="@Html.Raw(ViewBag.affectation.AffectationId)" class="form-control">

                    if (ViewBag.affectation.Lot.TelFixe != "" || ViewBag.affectation.Lot.TelPortable != "")
                    {

                        <div class="form-group">

                            <div class="col-md-offset-2 col-md-10">
                                <input id="submitFN" type="submit" value="Confirmer" class="btn btn-primary" />

                                <button style="display:none" id="submitFNLoading" class="btn btn-primary" type="button" disabled>
                                    <span class="spinner-grow spinner-grow-sm" role="status" aria-hidden="true"></span>
                                    <span class="sr-only">Loading...</span>
                                </button>

                            </div>

                        </div>

                    }


                }



                @using (Html.BeginForm("CreerFormulaireNote", "Formulaire", FormMethod.Post, new { enctype = "multipart/form-data", onsubmit = "showLoading()" }))
                {
                    @Html.AntiForgeryToken()

                    <div class="form-horizontal">
                        <hr />

                        @Html.ValidationSummary(true, "", new { @class = "text-danger" })

                        <input name="id" type="text" value="@ViewBag.id" style="visibility:hidden">

                        <div class="form-group">
                            @Html.Label("EtatClient", "Note client", htmlAttributes: new { @class = "control-label col-md-2" })
                            <div class="col-md-10">
                                @Html.DropDownList("EtatClient", ViewBag.TraiteList as SelectList, new { @class = "form-control", id = "dropdown" })

                            </div>
                        </div>

                        <div class="form-group" id="autre">
                            @Html.Label("DescriptionAutre", "Description", htmlAttributes: new { @class = "control-label col-md-2" })
                            <div class="col-md-10">
                                @Html.Editor("DescriptionAutre", new { htmlAttributes = new { @class = "form-control" } })
                            </div>
                        </div>


                        <div id="datetimePickerRDV" class="form-group row">
                            <label for="example-datetime-local-input" class="col-2 col-form-label">RDV pour le:</label>
                            <div class="col-8">
                                <input class="form-control" name="RDVDateTime" type="datetime-local" id="RDVDate">
                            </div>
                        </div>

                        <div id="datetimePickerRappel" class="form-group row">
                            <label for="example-datetime-local-input" class="col-2 col-form-label">Rappel pour le:</label>
                            <div class="col-8">
                                <input class="form-control" name="datetimePickerRappel" type="datetime-local" value="2011-08-19T13:45:00" id="example-datetime-local-input">
                            </div>
                        </div>

                        <div id="montant" class="form-group row">
                            <label id="textLabel" for="example-datetime-local-input" class="col-2 col-form-label"></label>
                            <div class="col-8">

                                <input name="soldetranche" type="number" step="0.001" id="exampleInputAmount" class="form-control">

                            </div>
                        </div>

                        <div id="recu" class="form-group row">
                            <label id="textLabel" for="example-datetime-local-input" class="col-2 col-form-label"></label>
                            <div class="col-8">

                                <div class="custom-file">
                                    <input type="file" name="postedFile" class="custom-file-input" id="customFileLang" lang="es">
                                    <label class="custom-file-label" for="customFileLang">Importer recu</label>


                                </div>
                                <br />
                                <img id="blah" width="200" height="150" src="#" alt="" />

                            </div>
                        </div>


                        <div class="form-group">

                            <div class="col-md-offset-2 col-md-10">
                                <input id="submitBtn" type="submit" value="Confirmer" class="btn btn-primary" />

                                <button style="display:none" id="submitLoading" class="btn btn-primary" type="button" disabled>
                                    <span class="spinner-grow spinner-grow-sm" role="status" aria-hidden="true"></span>
                                    <span class="sr-only">Loading...</span>
                                </button>


                                <span class="text-danger">@ViewBag.errormsg</span>

                            </div>

                        </div>

                    </div>
                }


            </div>

        </div>

        <br />

        <div class="card">
            <div class="card-header" id="headingTwo">

                <h2>Historique Client</h2>

            </div>

            <div class="card-body">


                <table class="table table-bordered table-condensed table-responsive" style="display:table">
                    <tr>
                        <th>

                        </th>
                        <th>
                            @Html.DisplayNameFor(model => model.EtatClient)
                        </th>

                        <th>
                            @Html.DisplayNameFor(model => model.DateRDV)
                        </th>
                        <th>
                            @Html.DisplayNameFor(model => model.DateRDVReporte)
                        </th>

                        <th>
                            @Html.DisplayNameFor(model => model.MontantDebInitial)
                        </th>

                        <th>
                            @Html.DisplayNameFor(model => model.MontantDebMAJ)
                        </th>

                        <th>
                            @Html.DisplayNameFor(model => model.MontantVerseDeclare)
                        </th>


                        <th>
                            @Html.DisplayNameFor(model => model.DescriptionAutre)
                        </th>

                        <th>
                            @Html.DisplayNameFor(model => model.TraiteLe)
                        </th>

                        <th>
                            @Html.DisplayNameFor(model => model.VerifieLe)
                        </th>
                        <th>
                            @Html.DisplayNameFor(model => model.Status)
                        </th>
                    </tr>

                    @foreach (var item in Model)
                    {
                        <tr class="p-3 mb-2 bg-white text-dark">

                            <td>

                                @if (item.EtatClient == WakilRecouvrement.Domain.Entities.Note.SOLDE || item.EtatClient == WakilRecouvrement.Domain.Entities.Note.SOLDE_TRANCHE)
                                {

                                    if (item.Status.ToString().Equals("EN_COURS"))
                                    {

                                        @Html.ActionLink("Supp", "deleteHist", "Formulaire", new { id = item.AffectationId, idHist = item.FormulaireId, msgError = "" }, new { @class = "btn btn-danger", onclick = "return confirm('voulez vous vraiment supprimer ?')" })

                                    }
                                    else
                                    {


                                         //@Html.ActionLink("Supp", "deleteHist", "Formulaire", new {  id = item.AffectationId, idHist = item.FormulaireId, msgError = "" }, new { @class = "btn btn-danger", onclick = "return confirm('voulez vous vraiment supprimer ?');", @disabled = "disabled" })


                                      }
                                }
                                else
                                {

                                    @Html.ActionLink("Supp", "deleteHist", "Formulaire", new {  id = item.AffectationId, idHist = item.FormulaireId, msgError = "" }, new { @class = "btn btn-danger", onclick = "return confirm('voulez vous vraiment supprimer ?');" })

                                }


                            </td>
                            <td>

                                @Html.DisplayFor(modelItem => item.EtatClient)

                            </td>

                            <td>


                                @if (item.DateRDV.ToString().Equals("01/01/0001 00:00:00"))
                                {
                                    <text></text>
                                }
                                else
                                {
                                    @Html.DisplayFor(modelItem => item.DateRDV)
                                }


                            </td>
                            <td>

                                @if (item.DateRDVReporte.ToString().Equals("01/01/0001 00:00:00"))
                                {
                                    <text></text>
                                }
                                else
                                {
                                    @Html.DisplayFor(modelItem => item.DateRDVReporte)
                                }
                            </td>

                            <td>


                                @Html.DisplayFor(modelItem => item.MontantDebInitial)


                            </td>

                            <td>

                                @Html.DisplayFor(modelItem => item.MontantDebMAJ)

                            </td>

                            <td>

                                @Html.DisplayFor(modelItem => item.MontantVerseDeclare)

                            </td>
                            <td>

                                @Html.DisplayFor(modelItem => item.DescriptionAutre)

                            </td>
                            <td>
                                @if (item.TraiteLe.ToString().Equals("01/01/0001 00:00:00"))
                                {
                                    <text></text>
                                }
                                else
                                {
                                    @Html.DisplayFor(modelItem => item.TraiteLe)
                                }

                            </td>
                            <td>
                                @if (item.VerifieLe.ToString().Equals("01/01/0001 00:00:00"))
                                {
                                    <text></text>
                                }
                                else
                                {
                                    @Html.DisplayFor(modelItem => item.VerifieLe)
                                }
                            </td>
                            <td>
                                @if (item.Status.ToString().Equals("NON_VERIFIE"))
                                {
                                    <text>Non verifié</text>
                                }
                                else if (item.Status.ToString().Equals("VERIFIE"))
                                {
                                    <text>Verifié</text>

                                }
                                else if (item.Status.ToString().Equals("EN_COURS"))
                                {
                                    <text>En attente...</text>
                                }
                            </td>

                        </tr>
                    }

                </table>


            </div>

        </div>



        <script>



            function showLoading() {

                document.getElementById("submitLoading").style.display = "block";
                document.getElementById("submitBtn").style.display = "none";

            }

            

            function showFNLoading() {

                document.getElementById("submitFNLoading").style.display = "block";
                document.getElementById("submitFN").style.display = "none";

            }


    var datetimePicker = document.getElementById("datetimePicker")

    var dropdown = document.getElementById("dropdown");


    function readURL(input) {
        if (input.files && input.files[0]) {
            var reader = new FileReader();

            reader.onload = function (e) {
                document.getElementById("blah").setAttribute('src', e.target.result)
            }

            reader.readAsDataURL(input.files[0]); // convert to base64 string
        }
    }

    function hideAll() {
        document.getElementById("autre").style.display= "none"
        document.getElementById("datetimePickerRDV").style.display= "none"
        document.getElementById("montant").style.display= "none"
        document.getElementById("datetimePickerRappel").style.display= "none"
        document.getElementById("recu").style.display= "none"

    }

    hideAll()

    document.getElementById("customFileLang").onchange = function () {
        readURL(this);
    }



        dropdown.onchange = function () {

            switch (dropdown.value) {
                case "INJOIGNABLE":
                    hideAll();

                    break;
                case "FAUX_NUM":
                    hideAll();

                    break;
                case "NRP":
                    hideAll();

                    break;
                case "RDV":
                    hideAll();


                    var now = new Date();
                    now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
                    document.getElementById('RDVDate').value = now.toISOString().slice(0, 16);


                    document.getElementById("datetimePickerRDV").style.display = "block"
                    break;

                case "SOLDE":
                    hideAll();

                       document.getElementById("montant").style.display = "block"
                    document.getElementById("recu").style.display = "block"

                    document.getElementById("textLabel").innerHTML = "Versement en TND:";
                   //document.getElementById("exampleInputAmount").max = "any";
                    document.getElementById("exampleInputAmount").value = @ViewBag.soldeDeb+ "";
                    //document.getElementById("exampleInputAmount").min = @ViewBag.soldeDeb +"";

                    break;
                case "REFUS_PAIEMENT":
                    hideAll();

                    break;
                case "A_VERIFIE":

                    hideAll();


                    break;
                case "RAPPEL":
                    hideAll();
                    document.getElementById("datetimePickerRappel").style.display = "block"

                    break;
                case "RACCROCHE":
                    hideAll();

                    break;
                case "SOLDE_TRANCHE":
                    hideAll();

                    document.getElementById("montant").style.display = "block"
                    document.getElementById("recu").style.display = "block"

                    document.getElementById("textLabel").innerHTML = "Tranche en TND:";

                    //document.getElementById("exampleInputAmount").max =  @ViewBag.soldeDeb +"";
                    document.getElementById("exampleInputAmount").value = "1.000";
                    document.getElementById("exampleInputAmount").min =0 +"";

                    break;
                case "AUTRE":
                    hideAll();
                    document.getElementById("autre").style.display = "block"

                    break;
            }

        }



            function supprimerHist(btn) {


                if (confirm("Ceci implique la suppression de l'operation, êtes vous sur de vouloir continuer ?  ")) {

                    alert(btn)

                }


            }

        </script>


        @section Scripts {
            @Scripts.Render("~/bundles/jqueryval")
        }

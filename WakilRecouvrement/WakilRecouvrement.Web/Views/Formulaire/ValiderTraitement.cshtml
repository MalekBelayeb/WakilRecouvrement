@model WakilRecouvrement.Domain.Entities.Formulaire

@{
    ViewBag.Title = "";
}

<h2>Valider les Traitements</h2>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>

<link href="~/lib/bootstrap/dist/css/bootstrap.css" rel="stylesheet" />

<link href="https://cdn.datatables.net/1.10.15/css/dataTables.bootstrap.min.css" rel="stylesheet" />
<link href="https://cdn.datatables.net/responsive/2.1.1/css/responsive.bootstrap.min.css" rel="stylesheet" />


<script src="https://cdn.datatables.net/1.10.15/js/jquery.dataTables.min.js"></script>

<script src="https://cdn.datatables.net/1.10.15/js/dataTables.bootstrap4.min.js">
</script>


<div class="row">
    <div class="col-xs-3">

        @Html.DropDownList("numLot", ViewData["list"] as SelectList, new { @class = "form-control" })

    </div>
    <div class="col-xs-3 col-md-5">


        @Html.DropDownList("traite", ViewBag.TraiteList as SelectList, new { @class = "form-control" })

    </div>
    <div class="col-xs-3">

        @Html.DropDownList("agent", ViewBag.AgentList as SelectList, new { @class = "form-control" })

    </div>
</div>
<br />
<span>
    Total:
</span>
<span><strong id="nbTotal"></strong></span>
<br />
<br />
<table id="demodata" class="table table-striped table-bordered dt-responsive nowrap">
    <thead>
        <tr>

            <th>Num Lot</th>
            <th>Verification</th>
            <th>Etat Client</th>
            <th>Montant Versé/Déclaré </th>
            <th>Affecté le:</th>
            <th>Agent</th>
            <th>Solde débiteur</th>
            <th>Compte</th>
            <th>IDClient</th>
            <th>NomClient</th>
            <th>Agence</th>

        </tr>
    </thead>
    <tbody>


    </tbody>
</table>


<span id="LocalStorage" style="visibility:hidden"></span>

<script>

    $(document).ready(function () {
        $.noConflict();

        var Table = DemoDatatable();


        $("#numLot").change(function () {

            Table = DemoDatatable();

        })

        $("#traite").change(function () {

            Table = DemoDatatable();

        })

        $("#agent").change(function () {

            Table = DemoDatatable();

        })

        function validerTraitement(id,valid) {
            $.ajax({
                type: 'POST',
                url: '/Formulaire/VerifierEtat/',
                dataType: 'json',
                data: { id: id, valid: valid },
                success: function (data) {

                    Table = DemoDatatable();

                }
            });

        }

        $(document).on('click', 'tbody  .verifie', function () {
            var data_row = Table.row($(this).closest('tr')).data();

            validerTraitement(data_row["FormulaireId"],true)
        });

        $(document).on('click', 'tbody  .reject', function () {
            var data_row = Table.row($(this).closest('tr')).data();

            validerTraitement(data_row["FormulaireId"], false)
        });

    });


    function DemoDatatable() {
        var table = $("#demodata").DataTable({
           

            "processing": true,
            "serverSide": true,
            "filter": true,
            "orderMulti": false,
            "destroy": true,
            "ordering": true,
            "ajax": {
                "url": '/Formulaire/ValiderTraitement',
                "type": "POST",
                "datatype": "json",
                "data": { IsValid: false, numLot: $("#numLot").val(), traite: $("#traite").val(), agent: $("#agent").val() }

            },
            "columns": [
                 
                  { "data": "NumLot", "name": "NumLot", "autoWidth": true }
                , {
                    "data": "FormulaireId", "name": "FormulaireId", "autoWidth": true, "render": function (data, type, row, meta) {
                        return "<div class='btn-group'><button type = 'button' class='btn btn-secondary dropdown-toggle' data-toggle='dropdown' aria-haspopup='true' aria-expanded='false' >Vérifier</button><div class='dropdown-menu dropdown-menu-right'><button class='verifie dropdown-item' type='button'>Valider</button><button class='reject dropdown-item' type='button'>Rejeter</button></div></div>";
                    }
                  }
                , { "data": "Etat", "name": "Etat", "autoWidth": true }
                , { "data": "MontantVerseDeclare", "name": "MontantVerseDeclare", "autoWidth": true }
                , { "data": "DateAff", "name": "DateAff", "autoWidth": true }
                , { "data": "Username", "name": "Username", "autoWidth": true }
                , { "data": "SoldeDebiteur", "name": "SoldeDebiteur", "autoWidth": true }
                , { "data": "Compte", "Name": "Compte", "autoWidth": true }
                , { "data": "IDClient", "name": "IDClient", "autoWidth": true }
                , { "data": "NomClient", "name": "NomClient", "autoWidth": true }
                , { "data": "DescIndustry", "name": "DescIndustry", "autoWidth": true }  
                
            ] 
        });

        table.on('xhr.dt',
            function (e, settings, data, xhr) {
                console.log(data["info"])
                 document.getElementById("nbTotal").innerHTML = data["info"]["nbTotal"]
            });

      
        return table;
    }

</script>